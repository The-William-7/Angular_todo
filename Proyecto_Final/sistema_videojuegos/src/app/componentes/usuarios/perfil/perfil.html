<div class="perfil-container">
  <div class="perfil-header">
    <h1>ğŸ‘¤ Mi Perfil</h1>
    <p>Gestiona tu informaciÃ³n personal, direcciones y mÃ©todos de pago</p>
  </div>

  <!-- Mensajes -->
  <div *ngIf="mensajeExito" class="alert alert-success">
    âœ… {{ mensajeExito }}
  </div>

  <div *ngIf="mensajeError" class="alert alert-error">
    âŒ {{ mensajeError }}
  </div>

  <div class="perfil-content" *ngIf="usuario">
    <!-- NavegaciÃ³n lateral -->
    <div class="perfil-sidebar">
      <button 
        (click)="cambiarSeccion('perfil')" 
        class="sidebar-btn"
        [class.active]="seccionActiva === 'perfil'"
      >
        ğŸ‘¤ InformaciÃ³n Personal
      </button>
      
      <button 
        (click)="cambiarSeccion('direcciones')" 
        class="sidebar-btn"
        [class.active]="seccionActiva === 'direcciones'"
      >
        ğŸ  Direcciones
      </button>
      
      <button 
        (click)="cambiarSeccion('pagos')" 
        class="sidebar-btn"
        [class.active]="seccionActiva === 'pagos'"
      >
        ğŸ’³ MÃ©todos de Pago
      </button>
      
      <button 
        (click)="cambiarSeccion('estadisticas')" 
        class="sidebar-btn"
        [class.active]="seccionActiva === 'estadisticas'"
      >
        ğŸ“Š Mis EstadÃ­sticas
      </button>
    </div>

    <!-- Contenido principal -->
    <div class="perfil-main">
      <!-- SECCIÃ“N INFORMACIÃ“N PERSONAL -->
      <div *ngIf="seccionActiva === 'perfil'" class="seccion-content">
        <div class="seccion-header">
          <h2>ğŸ‘¤ InformaciÃ³n Personal</h2>
          <button 
            *ngIf="!editandoPerfil"
            (click)="iniciarEdicionPerfil()"
            class="btn btn-outline"
          >
            âœï¸ Editar
          </button>
        </div>

        <div *ngIf="!editandoPerfil" class="info-display">
          <div class="info-grid">
            <div class="info-item">
              <label>Nombre completo</label>
              <p>{{ usuario.nombre }} {{ usuario.apellido }}</p>
            </div>
            <div class="info-item">
              <label>Email</label>
              <p>{{ usuario.email }}</p>
            </div>
            <div class="info-item">
              <label>TelÃ©fono</label>
              <p>{{ usuario.telefono || 'No especificado' }}</p>
            </div>
            <div class="info-item">
              <label>Fecha de nacimiento</label>
              <p>{{ usuario.fechaNacimiento ? (usuario.fechaNacimiento | date:'longDate') : 'No especificada' }}</p>
            </div>
            <div class="info-item">
              <label>Fecha de registro</label>
              <p>{{ usuario.fechaRegistro | date:'longDate' }}</p>
            </div>
            <div class="info-item">
              <label>Rol</label>
              <p>
                <span [class]="usuario.rol === 'admin' ? 'badge-admin' : 'badge-user'">
                  {{ usuario.rol === 'admin' ? 'ğŸ›¡ï¸ Administrador' : 'ğŸ‘¤ Usuario' }}
                </span>
              </p>
            </div>
          </div>
        </div>

        <!-- Formulario de ediciÃ³n -->
        <form *ngIf="editandoPerfil" (ngSubmit)="guardarPerfil()" class="edit-form">
          <div class="form-row">
            <div class="form-group">
              <label>Nombre *</label>
              <input
                type="text"
                [(ngModel)]="datosPerfilTemp.nombre"
                name="nombre"
                required
                class="form-input"
              >
            </div>
            <div class="form-group">
              <label>Apellido *</label>
              <input
                type="text"
                [(ngModel)]="datosPerfilTemp.apellido"
                name="apellido"
                required
                class="form-input"
              >
            </div>
          </div>

          <div class="form-group">
            <label>Email</label>
            <input
              type="email"
              [value]="usuario.email"
              disabled
              class="form-input"
            >
            <small class="helper-text">El email no se puede modificar</small>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>TelÃ©fono</label>
              <input
                type="tel"
                [(ngModel)]="datosPerfilTemp.telefono"
                name="telefono"
                class="form-input"
              >
            </div>
            <div class="form-group">
              <label>Fecha de nacimiento</label>
              <input
                type="date"
                [value]="datosPerfilTemp.fechaNacimiento | date:'yyyy-MM-dd'"
                (input)="datosPerfilTemp.fechaNacimiento = $any($event.target).valueAsDate"
                class="form-input"
              >
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" [disabled]="cargando">
              <span *ngIf="cargando" class="spinner"></span>
              {{ cargando ? 'Guardando...' : 'ğŸ’¾ Guardar Cambios' }}
            </button>
            <button type="button" (click)="cancelarEdicionPerfil()" class="btn btn-outline">
              âŒ Cancelar
            </button>
          </div>
        </form>
      </div>

      <!-- SECCIÃ“N DIRECCIONES -->
      <div *ngIf="seccionActiva === 'direcciones'" class="seccion-content">
        <div class="seccion-header">
          <h2>ğŸ  Mis Direcciones</h2>
          <button 
            (click)="iniciarEdicionDireccion()"
            class="btn btn-primary"
          >
            â• Agregar DirecciÃ³n
          </button>
        </div>

        <!-- Lista de direcciones -->
        <div *ngIf="!editandoDireccion && usuario.direcciones && usuario.direcciones.length > 0" class="items-list">
          <div *ngFor="let direccion of usuario.direcciones" class="item-card">
            <div class="item-content">
              <div class="item-header">
                <h4>{{ direccion.nombre }}</h4>
                <span *ngIf="direccion.esPrincipal" class="badge-primary">Principal</span>
              </div>
              <p>{{ direccion.direccion }}</p>
              <p>{{ direccion.ciudad }}, {{ direccion.codigoPostal }}</p>
              <p>{{ direccion.pais }}</p>
            </div>
            <div class="item-actions">
              <button 
                (click)="iniciarEdicionDireccion(direccion)"
                class="btn btn-small btn-outline"
              >
                âœï¸ Editar
              </button>
              <button 
                (click)="eliminarDireccion(direccion.id)"
                class="btn btn-small btn-danger"
              >
                ğŸ—‘ï¸ Eliminar
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="!editandoDireccion && (!usuario.direcciones || usuario.direcciones.length === 0)" class="empty-state">
          <p>ğŸ“­ No tienes direcciones guardadas</p>
          <p>Agrega una direcciÃ³n para recibir tus compras</p>
        </div>

        <!-- Formulario de direcciÃ³n -->
        <form *ngIf="editandoDireccion" (ngSubmit)="guardarDireccion()" class="edit-form">
          <div class="form-group">
            <label>Nombre de la direcciÃ³n *</label>
            <input
              type="text"
              [(ngModel)]="direccionTemp.nombre"
              name="nombre"
              placeholder="Ej: Casa, Trabajo"
              required
              class="form-input"
            >
          </div>

          <div class="form-group">
            <label>DirecciÃ³n completa *</label>
            <input
              type="text"
              [(ngModel)]="direccionTemp.direccion"
              name="direccion"
              placeholder="Calle, nÃºmero, colonia"
              required
              class="form-input"
            >
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Ciudad *</label>
              <input
                type="text"
                [(ngModel)]="direccionTemp.ciudad"
                name="ciudad"
                required
                class="form-input"
              >
            </div>
            <div class="form-group">
              <label>CÃ³digo Postal *</label>
              <input
                type="text"
                [(ngModel)]="direccionTemp.codigoPostal"
                name="codigoPostal"
                required
                class="form-input"
              >
            </div>
          </div>

          <div class="form-group">
            <label>PaÃ­s *</label>
            <select
              [(ngModel)]="direccionTemp.pais"
              name="pais"
              required
              class="form-input"
            >
              <option value="MÃ©xico">MÃ©xico</option>
              <option value="Estados Unidos">Estados Unidos</option>
              <option value="EspaÃ±a">EspaÃ±a</option>
              <option value="Argentina">Argentina</option>
              <option value="Colombia">Colombia</option>
            </select>
          </div>

          <div class="checkbox-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                [(ngModel)]="direccionTemp.esPrincipal"
                name="esPrincipal"
              >
              <span class="checkmark"></span>
              Establecer como direcciÃ³n principal
            </label>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" [disabled]="cargando">
              <span *ngIf="cargando" class="spinner"></span>
              {{ cargando ? 'Guardando...' : 'ğŸ’¾ Guardar DirecciÃ³n' }}
            </button>
            <button type="button" (click)="cancelarEdicionDireccion()" class="btn btn-outline">
              âŒ Cancelar
            </button>
          </div>
        </form>
      </div>

      <!-- SECCIÃ“N MÃ‰TODOS DE PAGO -->
      <div *ngIf="seccionActiva === 'pagos'" class="seccion-content">
        <div class="seccion-header">
          <h2>ğŸ’³ MÃ©todos de Pago</h2>
          <button 
            (click)="iniciarEdicionMetodoPago()"
            class="btn btn-primary"
          >
            â• Agregar MÃ©todo de Pago
          </button>
        </div>

        <!-- Lista de mÃ©todos de pago -->
        <div *ngIf="!editandoMetodoPago && usuario.metodosPago && usuario.metodosPago.length > 0" class="items-list">
          <div *ngFor="let metodo of usuario.metodosPago" class="item-card">
            <div class="item-content">
              <div class="item-header">
                <h4>
                  {{ metodo.tipo === 'tarjeta' ? 'ğŸ’³ Tarjeta' : 'ğŸ“§ PayPal' }}
                </h4>
                <span *ngIf="metodo.esPrincipal" class="badge-primary">Principal</span>
              </div>
              <p *ngIf="metodo.tipo === 'tarjeta'">
                **** **** **** {{ metodo.ultimosDigitos }}
              </p>
              <p *ngIf="metodo.tipo === 'tarjeta'">
                Expira: {{ metodo.fechaExpiracion }}
              </p>
              <p *ngIf="metodo.tipo === 'paypal'">
                {{ usuario.email }}
              </p>
            </div>
            <div class="item-actions">
              <button 
                (click)="iniciarEdicionMetodoPago(metodo)"
                class="btn btn-small btn-outline"
              >
                âœï¸ Editar
              </button>
              <button 
                (click)="eliminarMetodoPago(metodo.id)"
                class="btn btn-small btn-danger"
              >
                ğŸ—‘ï¸ Eliminar
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="!editandoMetodoPago && (!usuario.metodosPago || usuario.metodosPago.length === 0)" class="empty-state">
          <p>ğŸ’³ No tienes mÃ©todos de pago guardados</p>
          <p>Agrega un mÃ©todo de pago para realizar compras mÃ¡s rÃ¡pido</p>
        </div>

        <!-- Formulario de mÃ©todo de pago -->
        <form *ngIf="editandoMetodoPago" (ngSubmit)="guardarMetodoPago()" class="edit-form">
          <div class="form-group">
            <label>Tipo de mÃ©todo *</label>
            <select
              [(ngModel)]="metodoPagoTemp.tipo"
              name="tipo"
              required
              class="form-input"
            >
              <option value="tarjeta">ğŸ’³ Tarjeta de crÃ©dito/dÃ©bito</option>
              <option value="paypal">ğŸ“§ PayPal</option>
            </select>
          </div>

          <div *ngIf="metodoPagoTemp.tipo === 'tarjeta'">
            <div class="form-row">
              <div class="form-group">
                <label>Ãšltimos 4 dÃ­gitos *</label>
                <input
                  type="text"
                  [(ngModel)]="metodoPagoTemp.ultimosDigitos"
                  name="ultimosDigitos"
                  placeholder="1234"
                  maxlength="4"
                  required
                  class="form-input"
                >
              </div>
              <div class="form-group">
                <label>Fecha de expiraciÃ³n *</label>
                <input
                  type="text"
                  [(ngModel)]="metodoPagoTemp.fechaExpiracion"
                  name="fechaExpiracion"
                  placeholder="MM/AA"
                  required
                  class="form-input"
                >
              </div>
            </div>
          </div>

          <div class="checkbox-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                [(ngModel)]="metodoPagoTemp.esPrincipal"
                name="esPrincipal"
              >
              <span class="checkmark"></span>
              Establecer como mÃ©todo de pago principal
            </label>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" [disabled]="cargando">
              <span *ngIf="cargando" class="spinner"></span>
              {{ cargando ? 'Guardando...' : 'ğŸ’¾ Guardar MÃ©todo' }}
            </button>
            <button type="button" (click)="cancelarEdicionMetodoPago()" class="btn btn-outline">
              âŒ Cancelar
            </button>
          </div>
        </form>
      </div>

      <!-- SECCIÃ“N ESTADÃSTICAS -->
      <div *ngIf="seccionActiva === 'estadisticas'" class="seccion-content">
        <div class="seccion-header">
          <h2>ğŸ“Š Mis EstadÃ­sticas</h2>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">ğŸ•¹ï¸</div>
            <div class="stat-info">
              <h3>{{ getEstadisticas().juegosComprados }}</h3>
              <p>Juegos Comprados</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">ğŸ†</div>
            <div class="stat-info">
              <h3>{{ getEstadisticas().juegosCompletados }}</h3>
              <p>Juegos Completados</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">â°</div>
            <div class="stat-info">
              <h3>{{ getEstadisticas().tiempoJugado }}</h3>
              <p>Tiempo Jugado</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">ğŸ¯</div>
            <div class="stat-info">
              <h3>{{ getEstadisticas().generoFavorito }}</h3>
              <p>GÃ©nero Favorito</p>
            </div>
          </div>
        </div>

        <div class="stats-message">
          <p>ğŸ“ˆ Estas estadÃ­sticas se actualizarÃ¡n automÃ¡ticamente con tu actividad en GameStore</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Usuario no logueado -->
  <div *ngIf="!usuario" class="not-logged-in">
    <div class="not-logged-content">
      <h2>ğŸ”’ Inicia sesiÃ³n</h2>
      <p>Para acceder a tu perfil, necesitas iniciar sesiÃ³n</p>
      <div class="auth-buttons">
        <a routerLink="/login" class="btn btn-primary">Iniciar SesiÃ³n</a>
        <a routerLink="/registro" class="btn btn-outline">Crear Cuenta</a>
      </div>
    </div>
  </div>
</div>